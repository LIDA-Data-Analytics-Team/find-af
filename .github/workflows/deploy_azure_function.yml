name: Deploy FIND-AF API to Azure Function app

on:
  [push]

env:
  AZURE_FUNCTIONAPP_NAME: find-af-api-test # set this to your application's name
  AZURE_FUNCTIONAPP_PACKAGE_PATH: '.'   # set this to the path to your web app project, defaults to the repository root
  PYTHON_VERSION: '3.9'                 # set this to the Python version to use (supports 3.7, 3.8, 3.9)

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: 'Checkout GitHub action'
      uses: actions/checkout@v2

    - name: Setup Python ${{ env.PYTHON_VERSION }} Environment
      uses: actions/setup-python@v1
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 'Resolve Project Dependencies Using Pip'
      shell: bash
      run: |
        pushd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
        sudo apt install dirmngr gnupg apt-transport-https ca-certificates software-properties-common
        sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9
        sudo add-apt-repository 'deb https://cloud.r-project.org/bin/linux/ubuntu focal-cran40/'
        sudo apt install r-base
        R --version
        pwd ~
        ls ~
        whoami
        mkdir ~/Rpackages/
        echo "$R_LIBS"
        echo "$R_HOME"
        echo "export R_LIBS_USER=~/Rpackages/" >> ~/.bash_profile
        source ~/.bash_profile
        echo "$R_LIBS_USER"
        wget https://cran.r-project.org/src/contrib/Archive/randomForest/randomForest_4.6-14.tar.gz
        R CMD INSTALL randomForest_4.6-14.tar.gz -l=$R_LIBS_USER
        python -m pip install --upgrade pip
        pip install -r requirements.txt --target=".python_packages/lib/site-packages"
        popd
    - name: 'Run Azure Functions action'
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
